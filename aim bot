-- // Silent Aim GF – Full FOV + Head Lock + Wallbang + Team Check
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- lấy team player (mỗi game GF dùng khác nhau, support hết)
local function sameTeam(plr)
    if not plr or plr == LocalPlayer then return true end

    -- CASE 1: game dùng property Team
    if plr.Team ~= nil and LocalPlayer.Team ~= nil then
        return plr.Team == LocalPlayer.Team
    end

    -- CASE 2: game dùng attribute Team
    if plr:GetAttribute("Team") and LocalPlayer:GetAttribute("Team") then
        return plr:GetAttribute("Team") == LocalPlayer:GetAttribute("Team")
    end

    return false
end

local function getClosestTarget()
    local best = nil
    local closest = math.huge

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer 
           and not sameTeam(plr)  -- TEAM CHECK ✔
           and plr.Character
           and plr.Character:FindFirstChild("Head") 
           and plr.Character:FindFirstChild("HumanoidRootPart")
           and plr.Character:FindFirstChild("Humanoid")
           and plr.Character.Humanoid.Health > 0
        then
            local head = plr.Character.Head
            local pos, vis = Camera:WorldToViewportPoint(head.Position)

            if vis then
                local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
                local dist = (Vector2.new(pos.X, pos.Y) - center).Magnitude

                if dist < closest then
                    closest = dist
                    best = plr.Character
                end
            end
        end
    end

    return best
end


local old
old = hookmetamethod(game, "__namecall", function(self, ...)
    local args = {...}
    local method = getnamecallmethod()

    if method == "FireServer" and tostring(self):lower():find("shoot") then
        local target = getClosestTarget()

        if target and target:FindFirstChild("Head") then
            args[2] = target.Head.CFrame
            return old(self, unpack(args))
        end
    end

    return old(self, ...)
end)
--// PLAYER ESP – Box + Name + Team Check
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local RunService = game:GetService("RunService")

local ESP_Boxes = {}
local ESP_Names = {}

-- team check (hỗ trợ cả Team property & Attribute Team)
local function sameTeam(plr)
    if not plr or plr == LocalPlayer then return true end

    if plr.Team and LocalPlayer.Team then
        return plr.Team == LocalPlayer.Team
    end

    if plr:GetAttribute("Team") and LocalPlayer:GetAttribute("Team") then
        return plr:GetAttribute("Team") == LocalPlayer:GetAttribute("Team")
    end

    return false
end

local function createESP(plr)
    local box = Drawing.new("Square")
    box.Thickness = 2
    box.Filled = false
    box.Color = Color3.fromRGB(255, 0, 0)
    box.Visible = false

    local name = Drawing.new("Text")
    name.Size = 16
    name.Color = Color3.fromRGB(255, 255, 255)
    name.Center = true
    name.Outline = true
    name.Visible = false

    ESP_Boxes[plr] = box
    ESP_Names[plr] = name
end

local function removeESP(plr)
    if ESP_Boxes[plr] then ESP_Boxes[plr]:Remove() end
    if ESP_Names[plr] then ESP_Names[plr]:Remove() end
    ESP_Boxes[plr] = nil
    ESP_Names[plr] = nil
end

for _, plr in ipairs(Players:GetPlayers()) do
    if plr ~= LocalPlayer then createESP(plr) end
end

Players.PlayerAdded:Connect(function(plr)
    if plr ~= LocalPlayer then createESP(plr) end
end)

Players.PlayerRemoving:Connect(function(plr)
    removeESP(plr)
end)


RunService.RenderStepped:Connect(function()
    for plr, box in pairs(ESP_Boxes) do
        local char = plr.Character
        local name = ESP_Names[plr]

        if
            not char or
            not char:FindFirstChild("HumanoidRootPart") or
            not char:FindFirstChild("Humanoid") or
            char.Humanoid.Health <= 0 or
            sameTeam(plr) -- TEAM CHECK ✔
        then
            box.Visible = false
            name.Visible = false
            continue
        end

        local hrp = char.HumanoidRootPart
        local head = char:FindFirstChild("Head")

        local pos, onScreen = Camera:WorldToViewportPoint(hrp.Position)

        if not onScreen then
            box.Visible = false
            name.Visible = false
            continue
        end

        -- Box size
        local distance = (Camera.CFrame.Position - hrp.Position).Magnitude
        local scale = math.clamp(2 / distance, 0.3, 1.5)
        local height = 4 * scale
        local width = 2 * scale

        local x = pos.X - width * 50
        local y = pos.Y - height * 50

        box.Size = Vector2.new(width * 100, height * 100)
        box.Position = Vector2.new(x, y)
        box.Visible = true

        if head then
            local headPos = Camera:WorldToViewportPoint(head.Position + Vector3.new(0, 1, 0))
            name.Position = Vector2.new(headPos.X, headPos.Y - 15)
            name.Text = plr.Name
            name.Visible = true
        end
    end
end)
